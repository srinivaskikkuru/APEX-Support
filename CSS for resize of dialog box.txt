SELECT EI.EXPENDITURE_ITEM_ID,
       P.SEGMENT1                                            PROJECT_NUMBER,
       P.NAME                                                PROJECT_NAME,
       PT.PROJECT_TYPE,
       PT.PROJECT_TYPE_CLASS_CODE,
       T.TASK_NUMBER,
       T.TASK_NAME,
       EI.EXPENDITURE_ITEM_DATE,
       EI.EXPENDITURE_TYPE,
       (SELECT expenditure_category
          FROM pa_expenditure_types
         WHERE expenditure_type = ei.expenditure_type)
           EXPENDITURE_CATEGORY,
       (SELECT p.full_name
         FROM PER_ALL_PEOPLE_F p
         WHERE     p.person_id = x.incurred_by_person_id
               AND EI.expenditure_item_date BETWEEN p.effective_start_date
                                                AND p.effective_end_date)
           EMPLOYEE_NAME,
       J.NAME                                                JOB_NAME,
       (SELECT NAME FROM PER_JOBS JFIN
            WHERE JFIN.JOB_ID =(
                SELECT JR1.TO_JOB_ID FROM PER_JOBS J1, PA_JOB_RELATIONSHIPS JR1
                WHERE J1.JOB_ID = JR1.FROM_JOB_ID
                AND JR1.TO_JOB_GROUP_ID = 42
                AND JR1.FROM_JOB_ID = (SELECT J2.JOB_ID FROM PER_JOBS J2
                                       WHERE J2.NAME = (SELECT NAME FROM PER_JOBS J3
                                                        WHERE J3.JOB_ID =(
                                                                SELECT JR4.TO_JOB_ID FROM PER_JOBS J4, PA_JOB_RELATIONSHIPS JR4
                                                                WHERE J4.JOB_ID = JR4.FROM_JOB_ID
                                                                AND J4.NAME = J.NAME))))) FORECAST_JOB,             /*ADD BY T TEDESCO TO GRAB FORECAST JOB*/
       O1.NAME                                               EXPENDITURE_ORGANIZATION_NAME,                                     
       EI.NON_LABOR_RESOURCE,
       (SELECT EXPENDITURE_COMMENT
          FROM pa_expenditure_comments
         WHERE EXPENDITURE_ITEM_ID = EI.EXPENDITURE_ITEM_ID)
           expenditure_comment,
       EI.TRANSACTION_SOURCE,
       EI.ORIG_TRANSACTION_REFERENCE,
       (SELECT poh.segment1
          FROM po_headers_all        poh,
               ap_invoices_all       apa,
               ap_invoice_lines_all  apila
         WHERE     poh.po_header_id = apila.po_header_id
               AND apila.invoice_id = apa.invoice_id
               AND apa.invoice_id = ei.document_header_id
               AND ei.document_line_number = apila.line_number
               AND ei.transaction_source = 'AP INVOICE')
           matched_po_number,
       (SELECT pov.vendor_name
          FROM po_headers_all        poh,
               ap_invoices_all       apa,
               ap_invoice_lines_all  apila,
               po_vendors            pov
         WHERE     poh.po_header_id = apila.po_header_id
               AND apila.invoice_id = apa.invoice_id
               AND apa.invoice_id = ei.document_header_id
               AND ei.document_line_number = apila.line_number
               AND pov.vendor_id = poh.vendor_id
               AND ei.transaction_source = 'AP INVOICE')
           matched_po_vendor_name,
       EI.QUANTITY,
       EI.BURDEN_COST,
      DECODE (EI.unit_of_measure,
               NULL, pa_utils4.get_unit_of_measure (ei.expenditure_type),
               EI.unit_of_measure)
           UNIT_OF_MEASURE,
       pa_utils4.get_unit_of_measure_m (EI.unit_of_measure,
                                        ei.expenditure_type)
           UNIT_OF_MEASURE_M,
       DECODE (
           EI.system_linkage_function,
           'ST', DECODE (pa_security.view_labor_costs (P.project_id),
                         'Y', EI.burden_cost_rate,
                         NULL),
           'OT', DECODE (pa_security.view_labor_costs (P.project_id),
                         'Y', EI.burden_cost_rate,
                         NULL),
           EI.burden_cost_rate)
           burden_cost_rate,
       EI.project_currency_code,
       EI.project_rate_type,
       EI.project_rate_date,
       EI.project_exchange_rate,
       X.user_batch_name,
       DECODE (
           EI.cc_prvdr_organization_id,
           NULL, NULL,
           PA_EXPENDITURES_UTILS.GET_ORG_NAME_WOSEC (
               EI.CC_PRVDR_ORGANIZATION_ID))
           CC_PRVDR_ORGANIZATION_NAME,
       DECODE (
           EI.cc_recvr_organization_id,
           NULL, NULL,
           PA_EXPENDITURES_UTILS.GET_ORG_NAME_WOSEC (
               EI.CC_RECVR_ORGANIZATION_ID))
           CC_RECVR_ORGANIZATION_NAME,
       PA_EXPENDITURES_UTILS.GET_ORG_NAME_WOSEC (EI.ORG_ID)  PRVDR_ORG_NAME,
       DECODE (EI.recvr_org_id,
               NULL, NULL,
               PA_EXPENDITURES_UTILS.GET_ORG_NAME_WOSEC (EI.RECVR_ORG_ID))
           RECVR_ORG_NAME,
       EI.PROJFUNC_CURRENCY_CODE,
       TO_DATE (
           (SELECT TO_CHAR (CDL.PA_DATE)
              FROM PA_COST_DISTRIBUTION_LINES_ALL CDL
             WHERE     CDL.EXPENDITURE_ITEM_ID = EI.EXPENDITURE_ITEM_ID
                   AND CDL.LINE_TYPE = 'R'
                   AND CDL.LINE_NUM_REVERSED IS NULL
                   AND CDL.REVERSED_FLAG IS NULL
                   AND ROWNUM = 1),
           'DD-MON-RRRR')
           LATEST_PA_DATE,
       TO_DATE (
           (SELECT TO_CHAR (CDL.GL_DATE)
              FROM PA_COST_DISTRIBUTION_LINES_ALL CDL
             WHERE     CDL.EXPENDITURE_ITEM_ID = EI.EXPENDITURE_ITEM_ID
                   AND CDL.LINE_TYPE = 'R'
                   AND CDL.LINE_NUM_REVERSED IS NULL
                   AND CDL.REVERSED_FLAG IS NULL
                   AND ROWNUM = 1),
           'DD-MON-RRRR')
           LATEST_GL_DATE,
       TO_DATE (
           (SELECT TO_CHAR (CDL.RECVR_PA_DATE)
              FROM PA_COST_DISTRIBUTION_LINES_ALL CDL
             WHERE     CDL.EXPENDITURE_ITEM_ID = EI.EXPENDITURE_ITEM_ID
                   AND CDL.LINE_TYPE = 'R'
                   AND CDL.LINE_NUM_REVERSED IS NULL
                   AND CDL.REVERSED_FLAG IS NULL
                   AND ROWNUM = 1),
           'DD-MON-RRRR')
           LATEST_RECVR_PA_DATE,
       TO_DATE (
           (SELECT TO_CHAR (CDL.RECVR_GL_DATE)
              FROM PA_COST_DISTRIBUTION_LINES_ALL CDL
             WHERE     CDL.EXPENDITURE_ITEM_ID = EI.EXPENDITURE_ITEM_ID
                   AND CDL.LINE_TYPE = 'R'
                   AND CDL.LINE_NUM_REVERSED IS NULL
                   AND CDL.REVERSED_FLAG IS NULL
                   AND ROWNUM = 1),
           'DD-MON-RRRR')
           LATEST_RECVR_GL_DATE,
       SUBSTR (
           (SELECT CDL.PA_PERIOD_NAME
              FROM PA_COST_DISTRIBUTION_LINES_ALL CDL
             WHERE     CDL.EXPENDITURE_ITEM_ID = EI.EXPENDITURE_ITEM_ID
                   AND CDL.LINE_TYPE = 'R'
                   AND CDL.LINE_NUM_REVERSED IS NULL
                   AND CDL.REVERSED_FLAG IS NULL
                   AND ROWNUM = 1),
           1,
           15)
           LATEST_PA_PERIOD_NAME,
       SUBSTR (
           (SELECT CDL.GL_PERIOD_NAME
              FROM PA_COST_DISTRIBUTION_LINES_ALL CDL
             WHERE     CDL.EXPENDITURE_ITEM_ID = EI.EXPENDITURE_ITEM_ID
                   AND CDL.LINE_TYPE = 'R'
                   AND CDL.LINE_NUM_REVERSED IS NULL
                   AND CDL.REVERSED_FLAG IS NULL
                   AND ROWNUM = 1),
           1,
           15)
           LATEST_GL_PERIOD_NAME,
       SUBSTR (
           (SELECT CDL.RECVR_PA_PERIOD_NAME
              FROM PA_COST_DISTRIBUTION_LINES_ALL CDL
             WHERE     CDL.EXPENDITURE_ITEM_ID = EI.EXPENDITURE_ITEM_ID
                   AND CDL.LINE_TYPE = 'R'
                   AND CDL.LINE_NUM_REVERSED IS NULL
                   AND CDL.REVERSED_FLAG IS NULL
                   AND ROWNUM = 1),
           1,
           15)
           LATEST_RECVR_PA_PERIOD_NAME,
       SUBSTR (
           (SELECT CDL.RECVR_GL_PERIOD_NAME
              FROM PA_COST_DISTRIBUTION_LINES_ALL CDL
             WHERE     CDL.EXPENDITURE_ITEM_ID = EI.EXPENDITURE_ITEM_ID
                   AND CDL.LINE_TYPE = 'R'
                   AND CDL.LINE_NUM_REVERSED IS NULL
                   AND CDL.REVERSED_FLAG IS NULL
                   AND ROWNUM = 1),
           1,
           15)
           LATEST_RECVR_GL_PERIOD_NAME,
       X.person_type,
       EI.po_price_type,
       (SELECT h.segment1
          FROM po_headers_all h, po_lines_all l
         WHERE     l.po_header_id = h.po_header_id
               AND l.po_line_id = ei.po_line_id)
           po_number,
       (SELECT l.line_num
          FROM po_lines_all l
         WHERE l.po_line_id = ei.po_line_id)
           po_line_number,
       (SELECT f.meaning
          FROM fnd_lookups f
         WHERE     f.lookup_type = 'PRICE DIFFERENTIALS'
               AND f.lookup_code = ei.po_price_type)
           po_price_type_m,
       (SELECT f.meaning
          FROM pa_lookups f
         WHERE     f.lookup_type = 'PA_PERSON_TYPE'
               AND f.lookup_code = x.person_type)
           pa_person_type_m,
       DECODE (EI.wip_resource_id,
               NULL, NULL,
               pa_utils4.get_wip_resource_code (EI.wip_resource_id))
           wip_resource,
       DECODE (EI.inventory_item_id,
               NULL, NULL,
               pa_utils4.get_inventory_item (EI.inventory_item_id))
           inventory_item,
       EI.document_type,
       EI.document_distribution_type,
       DECODE (EI.legal_entity_id,
               NULL, NULL,
               pa_utils.GetLegalEntityName_FromID (EI.legal_entity_id))
           legal_entity,
       DECODE (
           EI.receiver_legal_entity_id,
           NULL, NULL,
           pa_utils.GetLegalEntityName_FromID (EI.receiver_legal_entity_id))
           receiver_legal_name
  FROM PA_PROJECTS_ALL               P,
       PA_TASKS                      T,
       PA_EXPENDITURE_ITEMS_ALL      EI,
       PA_EXPENDITURES_ALL           X,
       PA_PROJECT_TYPES_ALL          PT,
       PA_TRANSACTION_SOURCES        TR,
       HR_ALL_ORGANIZATION_UNITS_TL  O1,
       PER_JOBS                      J
WHERE     T.PROJECT_ID = P.PROJECT_ID
       AND EI.PROJECT_ID = P.PROJECT_ID
       AND P.PROJECT_TYPE = PT.PROJECT_TYPE
       AND P.ORG_ID = PT.ORG_ID
       AND EI.TASK_ID = T.TASK_ID
       AND EI.EXPENDITURE_ID = X.EXPENDITURE_ID
       AND NVL (EI.OVERRIDE_TO_ORGANIZATION_ID,
                X.INCURRED_BY_ORGANIZATION_ID) = O1.ORGANIZATION_ID
       AND EI.JOB_ID = J.JOB_ID(+)
       AND EI.TRANSACTION_SOURCE = TR.TRANSACTION_SOURCE(+)
       AND O1.LANGUAGE = USERENV ('LANG')
       and p.segment1 = :PROJNUMBER
